---
- name: icinga is installed
  apt:
    name: icinga
    state: installed

- name: passlib is installed
  apt:
    name: python-passlib
    state: installed

- name: icinga users are present
  htpasswd:
    path: /etc/icinga/htpasswd.users
    name: "{{ item.username }}"
    password: "{{ item.password }}"
  with_items: "{{ icinga_users }}"

- name: Enable external commands
  lineinfile:
    state: present
    dest: /etc/icinga/icinga.cfg
    line: 'check_external_commands=1'
    regexp: '^check_external_commands=\d$'


- name: Remove default Icinga objects
  file:
    path: "{{ item }}"
    state: absent
  notify: reload icinga
  with_items:
    - /etc/icinga/objects/hostgroups_icinga.cfg
    - /etc/icinga/objects/localhost_icinga.cfg
    - /etc/icinga/objects/services_icinga.cfg
    - /etc/icinga/objects/extinfo_icinga.cfg

- name: Objects are present
  copy:
    src: "{{ item }}"
    dest: /etc/icinga/objects/
  with_fileglob:
    - "{{ icinga_objects_dir }}/*"
  notify: reload icinga

- name: service is enabled
  service:
    name: icinga
    enabled: true

- name: service is started
  service:
    name: icinga
    state: started
